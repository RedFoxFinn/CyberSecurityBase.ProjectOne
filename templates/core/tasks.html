{% extends 'core/base.html' %}

{% block content %}
<section class="section">
    <h2 style="margin-bottom: 30px;">Tasks</h2>
    
    <!-- Search Form -->
    <div style="
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
        border-left: 6px solid #667eea;
    ">
        <form id="searchForm" onsubmit="performSearch(event)" style="display: flex; gap: 10px; align-items: center;">
            <div style="flex: 1;">
                <label for="searchInput" style="
                    display: block;
                    font-weight: 600;
                    color: #333;
                    margin-bottom: 6px;
                    font-size: 13px;
                    text-transform: uppercase;
                ">Search Tasks by Title</label>
                <input
                    type="text"
                    id="searchInput"
                    name="q"
                    placeholder="Enter search query..."
                    style="
                        width: 100%;
                        padding: 10px;
                        border: 2px solid #e0e0e0;
                        border-radius: 6px;
                        font-size: 14px;
                        box-sizing: border-box;
                        transition: border-color 0.3s;
                    "
                    onfocus="this.style.borderColor='#667eea'"
                    onblur="this.style.borderColor='#e0e0e0'"
                />
            </div>
            <button
                type="submit"
                style="
                    background: #667eea;
                    color: white;
                    padding: 10px 24px;
                    border-radius: 6px;
                    font-weight: 600;
                    font-size: 14px;
                    cursor: pointer;
                    border: none;
                    transition: background 0.3s;
                    align-self: flex-end;
                    height: 40px;
                "
                onmouseover="this.style.background='#764ba2'"
                onmouseout="this.style.background='#667eea'"
            >
                üîç Search
            </button>
            <button
                type="button"
                onclick="clearSearch()"
                style="
                    background: #6c757d;
                    color: white;
                    padding: 10px 24px;
                    border-radius: 6px;
                    font-weight: 600;
                    font-size: 14px;
                    cursor: pointer;
                    border: none;
                    transition: background 0.3s;
                    align-self: flex-end;
                    height: 40px;
                "
                onmouseover="this.style.background='#5a6268'"
                onmouseout="this.style.background='#6c757d'"
            >
                Clear
            </button>
        </form>
        
        <!-- Search Results Container -->
        <div id="searchResults" style="margin-top: 20px; display: none;">
            <div style="padding: 15px; background: #f0f7ff; border-left: 4px solid #667eea; border-radius: 4px;">
                <strong id="searchResultsCount"></strong>
                <div id="searchResultsList" style="margin-top: 15px;"></div>
            </div>
        </div>
    </div>
    
    <!-- Task Creation Form for Logged-in Users -->
    {% if user.is_authenticated %}
    <div style="
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
        border-left: 6px solid #764ba2;
    ">
        <details><summary style="margin: 0 0 20px 0; color: #333; font-size: 24px; font-weight: bold; padding: 1rem 0.3rem;">Create New Task</summary>
        
        <form method="POST" action="{% url 'core:task_create' %}" style="display: flex; flex-direction: column; gap: 15px;">
            {% csrf_token %}
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <!-- Title Field -->
                <div>
                    <label for="title" style="
                        display: block;
                        font-weight: 600;
                        color: #333;
                        margin-bottom: 6px;
                        font-size: 13px;
                        text-transform: uppercase;
                    ">Title *</label>
                    <input
                        type="text"
                        name="title"
                        id="title"
                        required
                        placeholder="Task title"
                        style="
                            width: 100%;
                            padding: 10px;
                            border: 2px solid #e0e0e0;
                            border-radius: 6px;
                            font-size: 14px;
                            font-family: inherit;
                            box-sizing: border-box;
                            transition: border-color 0.3s;
                        "
                        onfocus="this.style.borderColor='#764ba2'"
                        onblur="this.style.borderColor='#e0e0e0'"
                    />
                </div>
                
                <!-- Priority Field -->
                <div>
                    <label for="priority" style="
                        display: block;
                        font-weight: 600;
                        color: #333;
                        margin-bottom: 6px;
                        font-size: 13px;
                        text-transform: uppercase;
                    ">Priority</label>
                    <select
                        name="priority"
                        id="priority"
                        style="
                            width: 100%;
                            padding: 10px;
                            border: 2px solid #e0e0e0;
                            border-radius: 6px;
                            font-size: 14px;
                            font-family: inherit;
                            box-sizing: border-box;
                            background-color: white;
                            cursor: pointer;
                            transition: border-color 0.3s;
                        "
                        onfocus="this.style.borderColor='#764ba2'"
                        onblur="this.style.borderColor='#e0e0e0'"
                    >
                        <option value="3" selected>3 - Medium</option>
                        <option value="1">1 - Low</option>
                        <option value="2">2 - Low-Medium</option>
                        <option value="4">4 - High</option>
                        <option value="5">5 - Critical</option>
                    </select>
                </div>
            </div>
            
            <!-- Description Field -->
            <div>
                <label for="description" style="
                    display: block;
                    font-weight: 600;
                    color: #333;
                    margin-bottom: 6px;
                    font-size: 13px;
                    text-transform: uppercase;
                ">Description</label>
                <textarea
                    name="description"
                    id="description"
                    rows="3"
                    placeholder="Task description (optional)"
                    style="
                        width: 100%;
                        padding: 10px;
                        border: 2px solid #e0e0e0;
                        border-radius: 6px;
                        font-size: 14px;
                        font-family: inherit;
                        box-sizing: border-box;
                        resize: vertical;
                        transition: border-color 0.3s;
                    "
                    onfocus="this.style.borderColor='#764ba2'"
                    onblur="this.style.borderColor='#e0e0e0'"
                ></textarea>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <!-- Status Field -->
                <div>
                    <label for="status" style="
                        display: block;
                        font-weight: 600;
                        color: #333;
                        margin-bottom: 6px;
                        font-size: 13px;
                        text-transform: uppercase;
                    ">Status</label>
                    <select
                        name="status"
                        id="status"
                        style="
                            width: 100%;
                            padding: 10px;
                            border: 2px solid #e0e0e0;
                            border-radius: 6px;
                            font-size: 14px;
                            font-family: inherit;
                            box-sizing: border-box;
                            background-color: white;
                            cursor: pointer;
                            transition: border-color 0.3s;
                        "
                        onfocus="this.style.borderColor='#764ba2'"
                        onblur="this.style.borderColor='#e0e0e0'"
                    >
                        <option value="to_do" selected>üìã To Do</option>
                        <option value="in_progress">‚è≥ In Progress</option>
                        <option value="done">‚úÖ Done</option>
                    </select>
                </div>
                
                <!-- Due Date Field -->
                <div>
                    <label for="due_date" style="
                        display: block;
                        font-weight: 600;
                        color: #333;
                        margin-bottom: 6px;
                        font-size: 13px;
                        text-transform: uppercase;
                    ">Due Date (Optional)</label>
                    <input
                        type="date"
                        name="due_date"
                        id="due_date"
                        style="
                            width: 100%;
                            padding: 10px;
                            border: 2px solid #e0e0e0;
                            border-radius: 6px;
                            font-size: 14px;
                            font-family: inherit;
                            box-sizing: border-box;
                            background-color: white;
                            cursor: pointer;
                            transition: border-color 0.3s;
                        "
                        onfocus="this.style.borderColor='#764ba2'"
                        onblur="this.style.borderColor='#e0e0e0'"
                    />
                </div>
            </div>
            
            <button
                type="submit"
                style="
                    background: #764ba2;
                    color: white;
                    padding: 12px 24px;
                    border-radius: 6px;
                    font-weight: 600;
                    font-size: 14px;
                    cursor: pointer;
                    border: none;
                    transition: background 0.3s;
                    align-self: flex-start;
                "
                onmouseover="this.style.background='#5a3980'"
                onmouseout="this.style.background='#764ba2'"
            >
                ‚ú® Create Task
            </button>
        </form>
        </details>
    </div>
    {% endif %}
    
    <!-- User Info Section -->
    <div class="tasks-header">
        {% if user.is_authenticated %}
            <p class="user-info">Logged in as: <strong>{{ user.username }}</strong></p>
        {% else %}
            <p class="user-info">You are not logged in</p>
        {% endif %}
    </div>

    {% if tasks %}
    <h2>Task List ({{ tasks|length }} total)</h2>
    
    <div class="tasks-container">
        {% for task in tasks %}
            <div class="task-card" data-task-id="{{ task.id }}">
                <div class="task-header">
                    <h3 class="task-title">{{ task.title }}</h3>
                    <span class="task-priority priority-{{ task.priority }}">
                        {% if task.priority == 1 %}Low{% elif task.priority == 2 %}Medium{% elif task.priority == 3 %}High{% elif task.priority == 4 %}Very High{% else %}Critical{% endif %}
                    </span>
                </div>
                
                <div class="task-meta">
                    <span class="task-status" data-status="{{ task.status }}">
                        {% if task.status == 'todo' %}üìã To Do{% elif task.status == 'in_progress' %}‚è≥ In Progress{% else %}‚úÖ Done{% endif %}
                    </span>
                    <span class="task-owner">Owner: <strong>{{ task.owner.username }}</strong></span>
                </div>
                
                {% if task.description %}
                    <div class="task-description">
                        {{ task.description }}
                    </div>
                {% endif %}
                
                <div class="task-dates">
                    <small>Created: {{ task.created_at|date:"M d, Y H:i" }}</small>
                    {% if task.due_date %}
                        <small>Due: {{ task.due_date|date:"M d, Y H:i" }}</small>
                    {% endif %}
                </div>
                
                <div class="task-actions">
                    {% if vulnerable_mode or user.is_authenticated %}
                        <a href="{% url 'core:task_detail' task.id %}" class="btn btn-small btn-primary">View</a>
                    {% endif %}
                    {% if user.is_authenticated and vulnerable_mode or user.is_authenticated and task.owner == user %}
                        <a href="{% url 'core:task_edit' task.id %}" class="btn btn-small btn-secondary">Edit</a>
                    {% endif %}
                    {% if user.is_authenticated and vulnerable_mode or user.is_authenticated and task.owner == user %}
                        <button class="btn btn-small btn-danger" onclick="deleteTask({{ task.id }})">Delete</button>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>

    {% else %}
    <div class="no-tasks">
        <p>No tasks available</p>
        {% if not user.is_authenticated %}
            <p><a href="/admin/login/">Login</a> to see your tasks</p>
        {% elif vulnerable_mode %}
            <p>No tasks have been created yet</p>
        {% else %}
            <p>You haven't created any tasks yet</p>
        {% endif %}
    </div>
</section>
{% endif %}

<style>
    .tasks-header {
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .user-info {
        margin: 0 0 10px 0;
        color: #666;
    }

    .mode-warning {
        padding: 12px;
        background: #ffe0e0;
        border-left: 4px solid #c41e3a;
        color: #c41e3a;
        border-radius: 4px;
        margin-top: 10px;
    }

    .mode-info {
        padding: 12px;
        background: #e0ffe0;
        border-left: 4px solid #1e7e34;
        color: #1e7e34;
        border-radius: 4px;
        margin-top: 10px;
    }

    .tasks-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .task-card {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 20px;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .task-card:hover {
        border-color: #667eea;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        transform: translateY(-2px);
    }

    .task-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 10px;
        margin-bottom: 12px;
    }

    .task-title {
        margin: 0;
        color: #333;
        font-size: 1.1rem;
        flex: 1;
        word-break: break-word;
    }

    .task-priority {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        white-space: nowrap;
    }

    .priority-1 {
        background: #e8f5e9;
        color: #2e7d32;
    }

    .priority-2 {
        background: #fff3e0;
        color: #e65100;
    }

    .priority-3 {
        background: #ffe0b2;
        color: #d84315;
    }

    .priority-4 {
        background: #ffccbc;
        color: #bf360c;
    }

    .priority-5 {
        background: #ffcdd2;
        color: #c62828;
    }

    .task-meta {
        display: flex;
        gap: 15px;
        margin-bottom: 12px;
        flex-wrap: wrap;
    }

    .task-status {
        padding: 4px 8px;
        background: #f0f0f0;
        border-radius: 4px;
        font-size: 0.9rem;
        font-weight: 500;
    }

    .task-owner {
        font-size: 0.9rem;
        color: #666;
    }

    .task-description {
        color: #555;
        font-size: 0.95rem;
        line-height: 1.5;
        margin-bottom: 12px;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 4px;
        max-height: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .task-dates {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
        flex-wrap: wrap;
        color: #999;
        font-size: 0.85rem;
        border-top: 1px solid #f0f0f0;
        padding-top: 10px;
    }

    .task-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: auto;
    }

    .btn-small {
        padding: 8px 16px;
        font-size: 0.9rem;
        border-radius: 4px;
    }

    .btn-primary {
        background: #667eea;
        color: white;
    }

    .btn-primary:hover {
        background: #764ba2;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background: #5a6268;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background: #c82333;
    }

    .no-tasks {
        text-align: center;
        padding: 60px 20px;
    }

    .no-tasks p {
        color: #999;
        font-size: 1.1rem;
        margin: 10px 0;
    }

    .no-tasks a {
        color: #667eea;
        font-weight: 600;
    }

    @media (max-width: 768px) {
        .tasks-container {
            grid-template-columns: 1fr;
        }

        .task-header {
            flex-direction: column;
        }

        .task-priority {
            align-self: flex-start;
        }
    }
</style>

<script>
    function performSearch(event) {
        event.preventDefault();
        const query = document.getElementById('searchInput').value.trim();
        
        if (!query) {
            alert('Please enter a search query');
            return;
        }
        
        // Show loading state
        const resultsDiv = document.getElementById('searchResults');
        const resultsList = document.getElementById('searchResultsList');
        resultsList.innerHTML = '<p style="color: #666;">Searching...</p>';
        resultsDiv.style.display = 'block';
        
        // Perform the search via API
        fetch(`/api/search/?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const count = data.count;
                    document.getElementById('searchResultsCount').innerHTML = 
                        `<strong>Found ${count} result${count !== 1 ? 's' : ''} for: "${data.query}"</strong>`;
                    
                    if (count > 0) {
                        const resultsHTML = data.results.map(task => `
                            <div style="padding: 12px; background: white; margin-bottom: 8px; border-radius: 4px; border-left: 4px solid #667eea;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <strong style="color: #333;">${escapeHtml(task.title)}</strong>
                                        <div style="font-size: 0.9rem; color: #666; margin-top: 4px;">
                                            Status: <span style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">${escapeHtml(task.status)}</span>
                                            | Priority: <span style="font-weight: 600;">${task.priority}</span>
                                            | Owner: <strong>${escapeHtml(task.owner)}</strong>
                                        </div>
                                        ${task.description ? `<div style="font-size: 0.85rem; color: #555; margin-top: 6px; padding: 8px; background: #f8f9fa; border-radius: 3px;">${escapeHtml(task.description.substring(0, 100))}${task.description.length > 100 ? '...' : ''}</div>` : ''}
                                    </div>
                                    <a href="/tasks/${task.id}/" style="padding: 6px 12px; background: #667eea; color: white; text-decoration: none; border-radius: 4px; font-size: 0.9rem; margin-left: 10px;">View</a>
                                </div>
                            </div>
                        `).join('');
                        resultsList.innerHTML = resultsHTML;
                    } else {
                        resultsList.innerHTML = '<p style="color: #999;">No tasks found matching your search.</p>';
                    }
                } else {
                    resultsList.innerHTML = `<p style="color: #c62828;"><strong>Error:</strong> ${escapeHtml(data.error)}</p>`;
                }
            })
            .catch(error => {
                resultsList.innerHTML = `<p style="color: #c62828;"><strong>Error:</strong> ${escapeHtml(error)}</p>`;
            });
    }
    
    function clearSearch() {
        document.getElementById('searchInput').value = '';
        document.getElementById('searchResults').style.display = 'none';
        document.getElementById('searchInput').focus();
    }
    
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }

    function deleteTask(taskId) {
        if (confirm('Are you sure you want to delete this task?')) {
            fetch(`/api/tasks/${taskId}/delete/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => alert('Error deleting task: ' + error));
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
